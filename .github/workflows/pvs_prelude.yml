name: pvs_prelude

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        path: personoj

    - name: setup
      run: ${GITHUB_WORKSPACE}/personoj/tools/bootstrap.sh
      shell: sh

    - name: install personoj
      run: |
        eval $(opam env --switch=~/lambdapi --set-switch)
        bmake -C "${GITHUB_WORKSPACE}"/personoj/encoding install
        cp "${GITHUB_WORKSPACE}/personoj/tools/load-personoj.lisp" ~/.pvs.lisp
        echo '(load-personoj)' >> ~/.pvs.lisp

    - name: translate and typecheck
      run: |
        eval $(opam env --switch=~/lambdapi --set-switch)
        cd "${GITHUB_WORKSPACE}"/personoj/specs/tools/prelude || exit 1
        # Comment out theories that consume too much memory during 
        # typechecking
        sed -i 's/^floor_ceil$/-floor_ceil/' theories
        sed -i 's/^modulo_arithmetic$/-modulo_arithmetic/' theories
        sed -i 's/^mod$/-mod/' theories
        PERSONOJPATH="${GITHUB_WORKSPACE}"/personoj/
        bmake PERSONOJPATH="${PERSONOJPATH}" PVSPATH=~/PVS
